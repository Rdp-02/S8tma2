name: Automated Windows Virtual Workspace (ngrok-in)

on:
  workflow_dispatch:
    inputs:
      iso_url:
        description: "Direct ISO link for the OS you want to install"
        required: true
        default: ""

jobs:
  run-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üß© Initializing Environment
        run: |
          echo "üîß Preparing Your Virtual Workspace (4 Cores ‚Ä¢ 16 GB RAM ‚Ä¢ 256 GB SSD)"
          sudo apt update -qq
          sudo apt install -y qemu-system qemu-utils wget curl unzip mtools
          mkdir -p $HOME/vm
          echo "‚úÖ Environment initialized."

      - name: üíæ Downloading ISO
        run: |
          echo "üì¶ Downloading ISO from provided link..."
          cd $HOME/vm
          wget -O os.iso "${{ github.event.inputs.iso_url }}"
          ls -lh os.iso
          echo "‚úÖ ISO downloaded successfully."

      - name: üíΩ Creating 256 GB Virtual Disk
        run: |
          echo "üíΩ Creating 256 GB disk..."
          cd $HOME/vm
          qemu-img create -f qcow2 vm.qcow2 256G
          ls -lh vm.qcow2
          echo "‚úÖ Disk created."

      - name: üíæ Creating Automated Install Floppy
        run: |
          echo "ü§ñ Creating autounattend.xml for automated install..."
          cd $HOME/vm
          
          # Base64-encoded autounattend.xml
          XML_BASE64="PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHVudGVubGQgeG1sbj0idXJuOnNjaGVtYXMtbWljcm9zb2Z0LWNvbTphdXRvbmF0dGVuZCI+CiAgICA8c2V0dGluZ3MgcGFzcz0id2luZG93cEVEIj4KICAgICAgPGNvbXBvbmVudCBuYW1lPSJNZWNyb3NvZnQtV2luZG93cy1PdXRib29rL0ludGVybmV0aW9uYWwtQ29yZS1XaW5QRSIgcHJvY2Vzc29yQXJjaGl0ZWN0dXJlPSJhbWQ2NCIgcHVibGlrS2V5VG9rZW49IjMxYmYzODU2YWQzNjRlMzUiIGxhbmd1YWdlPSJuZXV0cmFsIiB2ZXJzaW9uU2NvcGU9Im5vblN4UyIgeG1sbnM6d2NtPSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL1dNaUNvbmZpZy8yMDAyL1N0YXRlIiB4bWxucz14c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU3BlYyI+CiAgICAgICAgPEF1dG9Mb2dvbj4KICAgICAgICAgICAgPFRpbWVab25lPVRDPC9UaW1lWm9uZT4KICAgICAgICAgIDwvQXV0b0xvZ29uPgogICAgPC9jb21wb25lbnQ+CiAgICA8L3NldHRpbmdzPgogIDx1bnRlbmRsPgogIDwvdW50ZW5kbD4KPC94bWw+"

          echo "$XML_BASE64" | base64 --decode > autounattend.xml
          echo "‚úÖ autounattend.xml created."
          
          qemu-img create -f raw floppy.img 1.44M
          mkfs.vfat floppy.img
          mcopy -i floppy.img autounattend.xml ::/
          echo "‚úÖ Floppy created with answer file."

      - name: üåê Setting Up ngrok (India Region)
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update
          sudo apt install ngrok
          ngrok config add-authtoken $NGROK_AUTH_TOKEN
          nohup ngrok tcp --region in 5901 > $HOME/vm/ngrok-vnc.log &
          nohup ngrok tcp --region in 3389 > $HOME/vm/ngrok-rdp.log &
          echo "‚úÖ ngrok setup done."

      - name: üñ•Ô∏è Launching VM
        run: |
          echo "üöÄ Booting Virtual Machine..."
          cd $HOME/vm
          nohup sudo qemu-system-x86_64 \
            -enable-kvm \
            -cpu host,kvm=on \
            -m 16G \
            -smp 4,sockets=1,cores=4,threads=1 \
            -drive file=vm.qcow2,format=qcow2,if=ide \
            -cdrom os.iso \
            -fda floppy.img \
            -vga qxl \
            -display vnc=:1 \
            -device qemu-xhci,id=xhci \
            -device usb-tablet,bus=xhci.0 \
            -netdev user,id=n0,hostfwd=tcp::3389-:3389 \
            -device e1000,netdev=n0 \
            -daemonize
          echo "‚úÖ VM is running."
          echo "üåê RDP port 3389 forwarded ‚Üí VNC display on :1 (Port 5901)"

      - name: üìã Displaying Access Details
        run: |
          echo "Waiting 10s for ngrok tunnels to establish..."
          sleep 10
          echo "===================================================================="
          echo "‚úÖ Your VM is installing automatically!"
          echo ""
          echo "You can watch the automated install on VNC (port 5901)."
          echo "!! DO NOT CLICK ANYTHING IN VNC !!"
          echo ""
          echo "After ~20-30 minutes, the VM will be ready."
          echo "Connect via RDP (port 3389) with these credentials:"
          echo "   User: Admin"
          echo "   Pass: Password123!"
          echo ""
          echo "Find your ngrok addresses on your dashboard:"
          echo "https://dashboard.ngrok.com/cloud-edge/endpoints"
          echo "===================================================================="

      - name: ‚è≥ Keeping VM Active (6 Hours, Minsk Time)
        run: |
          echo "üïê Your virtual workspace will remain active until:"
          TZ="Europe/Minsk" date -d "+6 hours" +"%Y-%m-%d %H:%M:%S %Z"
          echo ""
          echo "üïí Keeping your virtual workspace alive for 6 hours..."
          for i in $(seq 1 360); do
            printf "\r‚è≥ Runtime: %02d / 360 minutes elapsed" "$i"
            sleep 60
          done
          echo -e "\nüí§ Session complete ‚Äî shutting down."

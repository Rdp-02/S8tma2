name: Automated Windows Virtual Workspace (ngrok-in)

on:
  workflow_dispatch:
    inputs:
      iso_url:
        description: "Direct ISO link for the OS you want to install"
        required: true
        default: ""

jobs:
  run-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 hours

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üß© Initializing Environment
        run: |
          echo "üîß Preparing Your Virtual Workspace (4 Cores ‚Ä¢ 16 GB RAM ‚Ä¢ 256 GB SSD)"
          sudo apt update -qq
          sudo apt install -y qemu-system qemu-utils wget curl unzip mtools gpg
          mkdir -p $HOME/vm
          echo "‚úÖ Environment initialized."

      - name: üíæ Downloading ISO
        run: |
          echo "üì¶ Downloading ISO from provided link..."
          cd $HOME/vm
          wget -O os.iso "${{ github.event.inputs.iso_url }}"
          ls -lh os.iso
          echo "‚úÖ ISO downloaded successfully."

      - name: üíΩ Creating 256 GB Virtual Disk
        run: |
          echo "üíΩ Creating 256 GB disk..."
          cd $HOME/vm
          qemu-img create -f qcow2 vm.qcow2 256G
          ls -lh vm.qcow2
          echo "‚úÖ Disk created."

      - name: üíæ Creating Automated Install Floppy
        run: |
          echo "üíø Creating floppy disk image in $HOME/vm..."
          qemu-img create -f raw $HOME/vm/floppy.img 1.44M
          mkfs.vfat $HOME/vm/floppy.img
          echo "ü§ñ Copying autounattend.xml from repo to floppy..."
          mcopy -i $HOME/vm/floppy.img autounattend.xml ::/
          echo "‚úÖ Floppy created with answer file."

      - name: üåê Setting Up ngrok (India Region)
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if [ -z "$NGROK_AUTH_TOKEN" ]; then
            echo "‚ùå Error: NGROK_AUTH_TOKEN secret is not set."
            echo "Please add your ngrok authtoken as a repository secret."
            exit 1
          fi
          echo "üîê Installing ngrok..."
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | \
            sudo gpg --dearmor -o /usr/share/keyrings/ngrok-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/ngrok-archive-keyring.gpg] https://ngrok-agent.s3.amazonaws.com buster main" | \
            sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update
          sudo apt install ngrok
          echo "üîë Authenticating ngrok..."
          ngrok config add-authtoken $NGROK_AUTH_TOKEN
          echo "üîó Starting ngrok tunnels in Indian (in) region..."
          nohup ngrok tcp --region in 5901 --log=stdout > $HOME/vm/ngrok-vnc.log &
          nohup ngrok tcp --region in 3389 --log=stdout > $HOME/vm/ngrok-rdp.log &
          echo "‚úÖ ngrok setup done."

      - name: üñ•Ô∏è Launching VM
        run: |
          echo "üöÄ Booting Virtual Machine..."
          cd $HOME/vm
          nohup sudo qemu-system-x86_64 \
            -enable-kvm \
            -cpu host,kvm=on \
            -m 16G \
            -smp 4,sockets=1,cores=4,threads=1 \
            -boot order=d \
            -vga qxl \
            -display vnc=:1 \
            -device qemu-xhci,id=xhci \
            -device usb-tablet,bus=xhci.0 \
            -netdev user,id=n0,hostfwd=tcp::3389-:3389 \
            -device e1000,netdev=n0 \
            \
            # --- START: New SATA Controller ---
            # 1. Add the SATA controller
            -device ich9-ahci,id=sata \
            # 2. Attach the Hard Drive to the SATA controller
            -drive file=vm.qcow2,format=qcow2,id=disk,if=none -device ide-hd,bus=sata.0,drive=disk \
            # 3. Attach the CD-ROM to the SATA controller
            -drive file=os.iso,format=raw,id=cd,if=none,media=cdrom -device ide-cd,bus=sata.1,drive=cd \
            # 4. Attach the Floppy Drive
            -fda floppy.img \
            # --- END: New SATA Controller ---
            \
            -daemonize
          echo "‚úÖ VM is running."
          echo "üåê RDP port 3389 forwarded ‚Üí VNC display on :1 (Port 5901)"
          echo "üîç QEMU processes:"
          ps aux | grep qemu

      - name: üìã Displaying Access Details
        run: |
          echo "Waiting 10s for ngrok tunnels to establish..."
          sleep 10
          echo "===================================================================="
          echo "‚úÖ Your VM is installing automatically!"
          echo ""
          echo "You can watch the automated install on VNC (port 5901)."
          echo "!! DO NOT CLICK ANYTHING IN VNC !!"
          echo ""
          echo "After ~20-30 minutes, the VM will be ready."
          echo "Connect via RDP (port 3389) with these credentials:"
          echo "   User: Admin"
          echo "   Pass: Password123!"
          echo ""
          echo "Find your ngrok addresses on your dashboard:"
          echo "https://dashboard.ngrok.com/cloud-edge/endpoints"
          echo "===================================================================="

      - name: ‚è≥ Keeping VM Active (6 Hours, Minsk Time)
        run: |
          echo "üïê Your virtual workspace will remain active until:"
          TZ="Europe/Minsk" date -d "+6 hours" +"%Y-%m-%d %H:%M:%S %Z"
          echo ""
          echo "üïí Keeping your virtual workspace alive for 6 hours..."
          for i in $(seq 1 360); do
            printf "\r‚è≥ Runtime: %02d / 360 minutes elapsed" "$i"
            sleep 60
          done
          echo -e "\nüí§ Session complete ‚Äî shutting down."
